<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Infinite</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="h-100">
<div class="d-flex flex-column h-100">

  <!-- ==== TOP MENU ==== -->
  <header class="navbar navbar-dark bg-dark border-bottom border-secondary">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Infinite</span>
      <div class="d-flex gap-2">
        <button id="reset-map" class="btn btn-outline-danger btn-sm" disabled>Reset Map</button>
      </div>
    </div>
  </header>

  <div class="flex-grow-1 d-flex overflow-hidden">

    <!-- ==== MAP AREA ==== -->
    <main class="flex-grow-1 position-relative overflow-hidden bg-black" id="map-container">
      <div id="map-output" class="text-center text-muted p-3">Loading map…</div>
    </main>

    <!-- ==== RIGHT SIDEBAR ==== -->
    <aside class="bg-dark border-start border-secondary p-3" style="width:280px;min-width:280px;">
      <h6 class="text-muted text-uppercase small">Node Info</h6>
      <div id="node-panel" class="text-light small"><em>Select a node to view details.</em></div>

      <hr class="border-secondary">

      <h6 class="text-muted text-uppercase small mt-3">Actions</h6>
      <div id="action-panel"></div>
    </aside>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="js/rng.js"></script>
<script src="js/db.js"></script>
<script src="js/init.js"></script>      <!-- optional -->
<script src="js/events.js"></script>
<script src="js/nodeMap.js"></script>

<script>
  // ---------------------------------------------------------------
  // 1. Seed the RNG (change the number for a new map)
  // ---------------------------------------------------------------
  setRandomSeed(Date.now() % 100000);

  // ---------------------------------------------------------------
  // 2. Open DB → generate or load map → enable UI
  // ---------------------------------------------------------------
  (async () => {
    console.log('[INIT] Opening IndexedDB…');
    await DB.open('infinite', 1, db => {
      if (!db.objectStoreNames.contains('nodes')) {
        db.createObjectStore('nodes', { keyPath: 'id' });
      }
    });
    console.log('[INIT] DB ready');

    const existing = await DB.getAll('nodes');
    console.log(`[INIT] Existing nodes: ${existing.length}`);

    let nodes;
    if (existing.length === 0) {
      console.log('[INIT] First run – generating full map');
      nodes = await NodeMap.generateFullMap();
    } else {
      console.log(`[INIT] Loading ${existing.length} persisted nodes`);
      nodes = await NodeMap.loadMap();
    }

    // -------------------------------------------------------------
    // Quick debug table (first 10 nodes)
    // -------------------------------------------------------------
    console.table(nodes.slice(0, 10).map(n => ({
      id: n.id.slice(-6),
      area: n.area,
      biome: n.biome,
      deep: n.biome.startsWith('deep_'),
      neigh: n.neighbors.length
    })));

    $('#map-output').html(`
      <p>Loaded <strong>${nodes.length}</strong> nodes – ready for D3.</p>
      <small class="text-muted">Click <em>Reset Map</em> to regenerate.</small>
    `);

    // Enable the reset button now that everything is wired
    if (typeof window.enableResetButton === 'function') {
      window.enableResetButton();
    } else {
      console.warn('[INIT] enableResetButton not found yet');
    }
  })();
</script>
</body>
</html>